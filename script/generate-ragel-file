#!/bin/bash

set -e

CDPATH="" cd -- "$(dirname -- "$(dirname -- "$0")")"

make -s bin/gofumpt

ragel_file="$1"
go_file="$ragel_file.go"
tmp_file="$go_file.tmp"

script/ragel -Z -G2 -n -o "$go_file" "$ragel_file"

echo "// Code generated by $0 $*. DO NOT EDIT.
" > "$tmp_file"
sed $'s/}goto/}\\\ngoto/g' < "$go_file" | grep -v "^//line" >> "$tmp_file"
mv "$tmp_file" "$go_file"
bin/gofumpt -w "$go_file"
